# **************************************************************************** #
#                                                                              #
#                                                         :::      ::::::::    #
#    action.yml                                         :+:      :+:    :+:    #
#                                                     +:+ +:+         +:+      #
#    By: agaley <agaley@student.42lyon.fr>          +#+  +:+       +#+         #
#                                                 +#+#+#+#+#+   +#+            #
#    Created: 2022/11/08 01:07:00 by agaley            #+#    #+#              #
#    Updated: 2022/11/10 14:32:38 by agaley           ###   ########lyon.fr    #
#                                                                              #
# **************************************************************************** #

name: 'libftOps'
author: 'unkn0wn107'
description: 'CI pour ta libft'

runs:
    using: composite
    steps:
      - uses: actions/checkout@v2

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v34

      - name: Clone libftTester
        uses: actions/checkout@v2
        with:
          repository: Tripouille/libftTester
          path: libftTester

      - name: Install Valgrind
        shell: bash
        run: sudo apt install valgrind

      - name: Test changed functions
        shell: bash
        run: |
          cd libftTester
          export error_found=0
          export TERM=xterm #For tput from libftTester/Makefile
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if [[ $file == *.h || $file == "Makefile" ]]; then
              echo ">>> $file changed - Test all functions <<<"
              echo "If all your tests are OK and the moulinette KO you, please run the tester with valgrind (see README)"
              funcnames=($(find ../ -type f -name "*.c" -print0 | xargs -I {} -0 -n1 bash -c "echo {} | rev | cut -c3- | rev | sed 's#../ft_##'"))
              echo "Functions to test : $funcnames"
              for funcname in $funcnames; do
                output=$(trap "make $funcname" EXIT)
                echo "$(echo "$output" | sed 's/are OK//g' | grep OK)"
                kos=$(echo "$output" | sed 's/KO you//g' | grep KO)
                if [[ "$kos" != "" ]]; then echo "$kos"; error_found=1; fi
              done
            fi
          done
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if [[ $file == *.c ]]; then
              filename=${file%.*}
              funcname=${filename:3}
              echo ">>> $file changed - Test $funcname"
              output=$(make $funcname)
              echo "$(echo "$output" | grep OK)"
              kos=$(echo "$output" | sed 's/KO you//g' | grep KO)
              if [[ "$kos" != "" ]]; then echo "$kos"; error_found=1; fi
            fi
          done
          exit error_found
